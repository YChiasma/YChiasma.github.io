<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Local Journal</title>
  <style>
    body { font-family: Arial, sans-serif; max-width: 700px; margin: auto; padding: 20px; }
    textarea { width: 100%; height: 120px; margin-bottom: 10px; }
    button { padding: 8px 16px; margin: 5px 5px 15px 0; cursor: pointer; }
    .entry { background: #f4f4f4; padding: 12px; margin-bottom: 10px; border-radius: 6px; position: relative; }
    .timestamp { font-size: 0.9em; color: #555; margin-bottom: 5px; }
    .delete-btn { background: #d9534f; color: white; border: none; padding: 4px 8px; border-radius: 4px; font-size: 0.8em; position: absolute; top: 10px; right: 10px; }

    /* Modal Styles */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1000;
    }
    .modal {
      background: #fff;
      padding: 20px;
      border-radius: 8px;
      max-width: 400px;
      text-align: center;
      box-shadow: 0 4px 10px rgba(0,0,0,0.3);
    }
    .modal button {
      margin: 10px;
      padding: 8px 16px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
    }
    .modal .overwrite { background: #d9534f; color: #fff; }
    .modal .append { background: #5cb85c; color: #fff; }
    .modal .cancel { background: #777; color: #fff; }

    /* Toast styles */
    #toast {
      visibility: hidden;
      min-width: 200px;
      margin-left: -100px;
      background-color: #333;
      color: #fff;
      text-align: center;
      border-radius: 8px;
      padding: 12px;
      position: fixed;
      z-index: 2000;
      left: 50%;
      bottom: 30px;
      font-size: 14px;
      opacity: 0;
      transition: opacity 0.5s, bottom 0.5s;
    }
    #toast.show {
      visibility: visible;
      opacity: 1;
      bottom: 50px;
    }

    /* Responsive styles for mobile */
    @media (max-width: 768px) {
      body { padding: 10px; max-width: 100%; }
      textarea { height: 100px; width: 100%; box-sizing: border-box; font-size: 16px; }
      button:not(.delete-btn) { display: block; width: 100%; margin: 8px 0; }
      .modal { width: 90%; padding: 15px; }
      .entry { font-size: 0.95em; }
    }
  </style>
</head>
<body>
  <h1>My Journal</h1>
  <textarea id="journalInput" placeholder="Write your thoughts..."></textarea><br>
  <button onclick="saveEntry()">Save Entry</button>
  <button onclick="exportEntries()">Export Entries</button>
  <button onclick="copyEntries()">Copy Entries</button>
  <button onclick="document.getElementById('importFile').click()">Import Entries</button>
  <input type="file" id="importFile" accept=".txt" onchange="importEntries(event)" style="display:none;" />

  <h2>Previous Entries</h2>
  <div id="entries"></div>

  <!-- Modal container -->
  <div id="importModal" class="modal-overlay" style="display:none;">
    <div class="modal">
      <p>Do you want to overwrite or append the imported entries?</p>
      <button class="overwrite" onclick="handleImportChoice('O')">Overwrite</button>
      <button class="append" onclick="handleImportChoice('A')">Append</button>
      <button class="cancel" onclick="handleImportChoice('C')">Cancel</button>
    </div>
  </div>

  <!-- Toast notification -->
  <div id="toast"></div>

  <script>
    let pendingEntries = [];

    // Load saved entries from localStorage
    function loadEntries() {
      let entries = JSON.parse(localStorage.getItem('journalEntries')) || [];
      let container = document.getElementById('entries');
      container.innerHTML = '';
      entries.slice().reverse().forEach((entry, index) => {
        let div = document.createElement('div');
        div.className = 'entry';
        let realIndex = entries.length - 1 - index; // correct index in array
        div.innerHTML = `
          <div class="timestamp">${entry.time}</div>
          <div>${entry.text}</div>
          <button class="delete-btn" onclick="deleteEntry(${realIndex})">Delete</button>
        `;
        container.appendChild(div);
      });
    }

    // Save a new entry
    function saveEntry() {
      let text = document.getElementById('journalInput').value.trim();
      if (!text) return;
      let entries = JSON.parse(localStorage.getItem('journalEntries')) || [];
      let timestamp = new Date().toLocaleString();
      entries.push({ time: timestamp, text: text });
      localStorage.setItem('journalEntries', JSON.stringify(entries));
      document.getElementById('journalInput').value = '';
      loadEntries();
    }

    // Delete an entry by index with confirmation
    function deleteEntry(index) {
      if (!confirm('Are you sure you want to delete this entry?')) return;
      let entries = JSON.parse(localStorage.getItem('journalEntries')) || [];
      entries.splice(index, 1);
      localStorage.setItem('journalEntries', JSON.stringify(entries));
      loadEntries();
    }

    // Export entries as a .txt file
    function exportEntries() {
      let entries = JSON.parse(localStorage.getItem('journalEntries')) || [];
      if (entries.length === 0) {
        showToast('No entries to export.');
        return;
      }
      let content = entries.map(e => `${e.time}\n${e.text}\n\n`).join('');
      let blob = new Blob([content], { type: 'text/plain' });
      let url = URL.createObjectURL(blob);
      let a = document.createElement('a');
      a.href = url;
      a.download = 'journal_entries.txt';
      a.click();
      URL.revokeObjectURL(url);
      showToast('Entries exported successfully!');
    }

    // Copy entries to clipboard
    function copyEntries() {
      let entries = JSON.parse(localStorage.getItem('journalEntries')) || [];
      if (entries.length === 0) {
        showToast('No entries to copy.');
        return;
      }
      let content = entries.map(e => `${e.time}\n${e.text}\n\n`).join('');
      navigator.clipboard.writeText(content).then(() => {
        showToast('Entries copied to clipboard!');
      }).catch(err => {
        showToast('Failed to copy entries: ' + err);
      });
    }

    // Show toast notification
    function showToast(message) {
      let toast = document.getElementById('toast');
      toast.textContent = message;
      toast.className = 'show';
      setTimeout(() => {
        toast.className = toast.className.replace('show', '');
      }, 3000);
    }

    // Import entries from a .txt file with date detection
    function importEntries(event) {
      let file = event.target.files[0];
      if (!file) return;

      let reader = new FileReader();
      reader.onload = function(e) {
        let content = e.target.result.trim();
        if (!content) return;

        let lines = content.split(/\r?\n/);
        let newEntries = [];
        let currentEntry = null;

        // Regex to detect common date formats (MM/DD/YYYY, YYYY-MM-DD, locale strings)
        let dateRegex = /(\d{1,4}[\/\-]\d{1,2}[\/\-]\d{1,4}|\w{3,9}\s+\d{1,2},\s*\d{4}|\d{1,2}:\d{2}:\d{2})/;

        lines.forEach(line => {
          if (dateRegex.test(line)) {
            if (currentEntry) {
              currentEntry.text = currentEntry.text.trim();
              newEntries.push(currentEntry);
            }
            currentEntry = { time: line.trim(), text: '' };
          } else if (currentEntry) {
            currentEntry.text += (currentEntry.text ? "\n" : "") + line.trim();
          }
        });

        if (currentEntry) {
          currentEntry.text = currentEntry.text.trim();
          newEntries.push(currentEntry);
        }

        if (newEntries.length === 0) {
          showToast('No valid entries found in file.');
          return;
        }

        pendingEntries = newEntries;
        document.getElementById('importModal').style.display = 'flex';
      };
      reader.readAsText(file);
    }

    // Handle modal choice
    function handleImportChoice(choice) {
      document.getElementById('importModal').style.display = 'none';
      if (!pendingEntries.length) return;

      let entries = JSON.parse(localStorage.getItem('journalEntries')) || [];

      if (choice === 'O') {
        entries = pendingEntries;
      } else if (choice === 'A') {
        entries = entries.concat(pendingEntries);
      } else {
        pendingEntries = [];
        return;
      }

      localStorage.setItem('journalEntries', JSON.stringify(entries));
      pendingEntries = [];
      loadEntries();
      showToast('Entries imported successfully!');
    }

    // Load entries when page loads
    window.onload = loadEntries;
  </script>
</body>
</html>

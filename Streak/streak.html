<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Streak Viewer — Firebase Sync with Login</title>
  <style>
    .day{ color: #e6eef8; }
    :root{ --bg:#0f1724; --card:#0b1220; --muted:#94a3b8; --accent:#7c3aed; --ok:#16a34a; --bad:#1f2937; --cell-size:44px; }
    *{box-sizing:border-box}
    body{margin:0;font-family:Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;color:#e6eef8;background:linear-gradient(180deg,#071027 0%, #071426 100%);min-height:100vh;display:flex;align-items:center;justify-content:center;padding:24px}
    .app{width:980px;max-width:96%;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));border:1px solid rgba(255,255,255,0.04);padding:18px;border-radius:14px;box-shadow:0 8px 30px rgba(2,6,23,0.6)}
    header{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
    .title{display:flex;gap:12px;align-items:center}
    h1{font-size:18px;margin:0}
    .sub{color:var(--muted);font-size:13px}
    .controls{display:flex;gap:8px;align-items:center}
    .btn{background:transparent;border:1px solid rgba(255,255,255,0.04);color:var(--muted);padding:8px 10px;border-radius:10px;cursor:pointer}
    .btn.primary{background:linear-gradient(90deg,var(--accent),#5b21b6);border:none;color:white}
    .calendar-wrap{display:flex;gap:14px;align-items:flex-start}
    .month-card{position:relative;background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005));border-radius:12px;padding:12px;width:100%;max-width:680px;overflow:hidden}
    .month-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
    .month-title{font-weight:600}
    .grid{display:grid;grid-template-columns:repeat(7, var(--cell-size));gap:8px}
    .weekday{font-size:12px;color:var(--muted);text-align:center}
    .day{width:var(--cell-size);height:var(--cell-size);display:flex;align-items:center;justify-content:center;border-radius:8px;background:rgba(255,255,255,0.01);cursor:pointer;position:relative;transition:transform .12s ease, box-shadow .12s ease}
    .day:hover{transform:translateY(-4px)}
    .day.inactive{opacity:0.22;cursor:default}
    .day[data-state="done"]{color:white;border-color:#cacaca;background:linear-gradient(180deg, rgba(180,180,250,0.85), rgba(80,80,120,0.85));box-shadow:0 6px 18px rgba(124,58,237,0.08);}
    .day .n{font-size:12px}
    .legend{display:flex;gap:6px;align-items:center;color:var(--muted);font-size:13px;margin-top:8px}
    .legend .dot{width:12px;height:12px;border-radius:3px;background:linear-gradient(180deg, rgba(180,180,250,0.85), rgba(88,88,132,0.85))}
    aside{width:260px;min-width:220px}
    .panel{background:linear-gradient(180deg, rgba(255,255,255,0.01), rgba(255,255,255,0.005));padding:12px;border-radius:12px}
    .stat{font-size:28px;font-weight:700}
    .muted{color:var(--muted);font-size:13px}
    .month-carousel{display:flex;gap:10px;align-items:center;overflow:hidden;padding:6px}
    .month-item{min-width:86px;padding:8px;border-radius:10px;text-align:center;cursor:pointer}
    .month-item.active{background:rgba(255,255,255,0.02);border:1px solid rgba(255,255,255,0.03)}
    .footer{margin-top:12px;text-align:center;color:var(--muted);font-size:13px}
    #loginForm{margin-bottom:12px;display:flex;gap:8px;align-items:center}
    #loginForm input{padding:6px;border-radius:6px;border:1px solid rgba(255,255,255,0.1);background:#1e293b;color:white}
    .loading-overlay{position:absolute;top:0;left:0;width:100%;height:100%;background:rgba(15,23,36,0.8);display:flex;align-items:center;justify-content:center;z-index:10;}
    .spinner{width:36px;height:36px;border:4px solid rgba(255,255,255,0.2);border-top-color:var(--accent);border-radius:50%;animation:spin 1s linear infinite}
    @keyframes spin{to{transform:rotate(360deg)}}
    @keyframes fadeInUp{0%{opacity:0;transform:translateY(10px);}100%{opacity:1;transform:translateY(0);}}
    .fadeInUp{animation:fadeInUp .3s ease forwards}
    @keyframes pulse{0%{transform:scale(1)}50%{transform:scale(1.15)}100%{transform:scale(1)}}
    .pulse{animation:pulse .4s ease}
  </style>
</head>
<body>
  <div class="app" id="app">
    <form id="loginForm">
      <input type="email" id="email" placeholder="Email" required />
      <input type="password" id="password" placeholder="Password" required />
      <button type="submit" class="btn primary">Login</button>
    </form>

    <header>
      <div class="title">
        <div>
          <h1>Streak Viewer</h1>
          <div class="sub">Streaks synced with Firebase — login required</div>
        </div>
      </div>
      <div class="controls">
        <button class="btn" id="todayBtn">Today</button>
        <button class="btn primary" id="clearBtn">Clear all</button>
        <button class="btn" id="logoutBtn" style="display:none">Logout</button>
      </div>
    </header>

    <div style="display:flex; gap:8px; align-items:center">
      <select id="streakSelect" class="btn">
        <option value="default">Default</option>
        <option value="Running">Running</option>
        <option value="Meditation">Meditation</option>
      </select>
<label style="display:flex;align-items:center;gap:6px">
  <input type="checkbox" id="publicToggle"> Public
</label>
  <button id="shareLinkBtn" class="btn" style="display:none">Copy Share Link</button>
      <button class="btn" id="newStreakBtn">+ Add Streak</button>

</div>


    <div class="calendar-wrap">
      <div class="month-card" aria-live="polite">
        <div class="loading-overlay" id="loadingOverlay" style="display:none"><div class="spinner"></div></div>
        <div class="month-header">
          <div style="display:flex;gap:8px;align-items:center">
            <button class="btn" id="prevMonth">◀</button>
            <div class="month-title" id="monthTitle">Month</div>
            <button class="btn" id="nextMonth">▶</button>
          </div>
          <div class="muted" id="rangeLabel">Showing</div>
        </div>
        <div class="grid" style="margin-bottom:6px">
          <div class="weekday">Sun</div><div class="weekday">Mon</div><div class="weekday">Tue</div><div class="weekday">Wed</div><div class="weekday">Thu</div><div class="weekday">Fri</div><div class="weekday">Sat</div>
        </div>
        <div class="grid" id="daysGrid"></div>
        <div class="legend"><span class="dot"></span><span>Completed</span></div>
      </div>
      <aside>
        <div class="panel" id="statsPanel">
          <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
            <div>
              <div class="muted">Current streak</div>
              <div class="stat" id="currentStreak">0</div>
            </div>
            <div>
              <div class="muted">Longest streak</div>
              <div class="stat" id="longestStreak">0</div>
            </div>
          </div>
          <div style="display:flex;gap:8px;justify-content:space-between;margin-top:10px">
            <div class="muted">Total days marked</div>
            <div id="totalMarked">0</div>
          </div>
        </div>
      </aside>
    </div>
    <div class="footer">Built with ❤️ and Firebase sync</div>
  </div>

  <script type="module">
const urlParams = new URLSearchParams(window.location.search);
const publicUser = urlParams.get("user");
const publicStreak = urlParams.get("streak");

    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
    import { getFirestore, doc, setDoc, getDoc, deleteDoc, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";
    import { getAuth, onAuthStateChanged, setPersistence, browserLocalPersistence, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAtlpMxWZ75kX_0c_SooL8lzeFXqOhAZgc",
      authDomain: "streak-eda1a.firebaseapp.com",
      projectId: "streak-eda1a",
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // Ensure user stays logged in across tabs/pages
    await setPersistence(auth, browserLocalPersistence);

    let userId = null;
    let cache = {};
    let prevStats = {current:0,longest:0,total:0};

let publicMode = false;

if (publicUser && publicStreak) {
  // Public view mode
  console.log("Public mode");
  publicMode = true;
  document.getElementById("loginForm").style.display = "none";
  document.getElementById("logoutBtn").style.display = "none";
  document.getElementById("clearBtn").style.display = "none";
  document.getElementById("todayBtn").style.display = "none";
  document.getElementById("publicToggle").disabled = true;
  document.getElementById("shareLinkBtn").style.display = "none";

  loadPublicStreak(publicUser, publicStreak);
}

async function loadPublicStreak(uid, streakName) {
  const streakDocRef = doc(db, "users", uid, "streaks", streakName);
  const streakSnap = await getDoc(streakDocRef);
  if (!streakSnap.exists() || !streakSnap.data().public) {
    alert("This streak is private or does not exist.");
    return;
  }

  cache = {};
  const daysCol = collection(db, "users", uid, "streaks", streakName, "days");
  const snaps = await getDocs(daysCol);
  snaps.forEach(docSnap => (cache[docSnap.id] = true));
  const today = new Date();
  setView(today.getFullYear(), today.getMonth());
}


    function uidDate(d){
      const y=d.getFullYear(); const m=(d.getMonth()+1).toString().padStart(2,'0'); const day=d.getDate().toString().padStart(2,'0');
      return `${y}-${m}-${day}`;
    }

    let viewYear, viewMonth;

    function setView(y,m){ viewYear=y; viewMonth=m; loadMonthRange(y,m); }

    function getMonthInfo(y,m){
      const first=new Date(y,m,1); const last=new Date(y,m+1,0);
      return {firstDayIndex:first.getDay(), days:last.getDate()}
    }

    function streakRef(dateStr) {
      return doc(db, "users", userId, "streaks", currentStreakName, "days", dateStr);
    }

    async function isDone(dateStr){ if(dateStr in cache) return cache[dateStr];
      const snap = await getDoc(streakRef(dateStr));
      cache[dateStr] = snap.exists();
      return cache[dateStr];
    }

    async function toggleDay(dateStr){
      if(await isDone(dateStr)){
        await deleteDoc(streakRef(dateStr));
        cache[dateStr]=false;
      } else {
        await setDoc(streakRef(dateStr), {done:true, ts:Date.now()});
        cache[dateStr]=true;
      }
      render();
    }

    function animateNumber(el, from, to, duration=500){
      const start = performance.now();
      const easeOutCubic = t => 1 - Math.pow(1-t,3);
      function step(time){
        let t = Math.min((time-start)/duration,1);
        el.textContent = Math.floor(from + (to-from)*easeOutCubic(t));
        if(t<1) requestAnimationFrame(step);
      }
      requestAnimationFrame(step);
    }

    async function render(){
      if(!userId && !publicMode) return;
      const daysGrid=document.getElementById('daysGrid');
      const {firstDayIndex, days}=getMonthInfo(viewYear, viewMonth);
      const monName=new Date(viewYear,viewMonth,1).toLocaleString(undefined,{month:'long',year:'numeric'});
      document.getElementById('monthTitle').textContent=monName;
      document.getElementById('rangeLabel').textContent=`Viewing ${monName}`;
      daysGrid.innerHTML='';
      for(let i=0;i<firstDayIndex;i++){
        const el=document.createElement('div'); el.className='day inactive'; daysGrid.appendChild(el);
      }
      for(let d=1;d<=days;d++){
        const date=new Date(viewYear,viewMonth,d); const id=uidDate(date);
        const el=document.createElement('button'); el.className='day'; el.innerHTML=`<div class="n">${d}</div>`;
        if(cache[id]) el.setAttribute('data-state','done');
        el.addEventListener('click',()=>toggleDay(id));
        daysGrid.appendChild(el);
      }
      daysGrid.classList.remove('fadeInUp');
      void daysGrid.offsetWidth;
      daysGrid.classList.add('fadeInUp');
      updateStats();
      document.getElementById('loadingOverlay').style.display='none';
      highlightToday();
    }

    function updateStats(){
      const keys=Object.keys(cache).filter(k=>cache[k]).sort();
      const total = keys.length;
      let longest=0, running=0, prev=null;
      for(const k of keys){
        const [y,m,d]=k.split('-').map(Number);
        const dt=new Date(y,m-1,d);
        if(!prev) running=1; else{
          const diff=(dt-prev)/(1000*60*60*24);
          if(diff===1) running++; else running=1;
        }
        if(running>longest) longest=running;
        prev=dt;
      }
      let cur=0; let t=new Date();
      while(true){ const k=uidDate(t); if(cache[k]){cur++; t.setDate(t.getDate()-1);} else break; }
      const panel=document.getElementById('statsPanel');
      panel.classList.remove('fadeInUp');
      void panel.offsetWidth;
      panel.classList.add('fadeInUp');
      animateNumber(document.getElementById('currentStreak'), prevStats.current, cur);
      animateNumber(document.getElementById('longestStreak'), prevStats.longest, longest);
      animateNumber(document.getElementById('totalMarked'), prevStats.total, total);
      prevStats={current:cur,longest:longest,total:total};
    }

    async function loadMonthRange(y,m){
      if(!userId && !publicMode) return;
      document.getElementById('loadingOverlay').style.display='flex';
      const start=new Date(y,m-1,1);
      const end=new Date(y,m+2,0);
      let streaksCol = null;
      if(!publicMode)
        streaksCol = collection(db, "users", userId, "streaks", currentStreakName, "days");
      else
        streaksCol = collection(db, "users", publicUser, "streaks", publicStreak, "days");
      const q=query(
        streaksCol,
        where("ts", ">=", start.getTime()),
        where("ts", "<=", end.getTime())
      );
      const snaps=await getDocs(q);
      snaps.forEach(docSnap=>{
        if(docSnap.exists()){
          cache[docSnap.id] = true;
        }
      });
      render();
    }

    function highlightToday(){
      const today = new Date();
      if(today.getFullYear()!==viewYear || today.getMonth()!==viewMonth) return;
      const id = uidDate(today);
      const days = document.querySelectorAll('#daysGrid .day');
      days.forEach(day=>{
        if(day.textContent==today.getDate().toString()){
          day.classList.add('pulse');
          day.scrollIntoView({behavior:'smooth', block:'center'});
          setTimeout(()=>day.classList.remove('pulse'),400);
        }
      });
    }

    document.getElementById('prevMonth').addEventListener('click',()=>{const dt=new Date(viewYear,viewMonth-1,1); setView(dt.getFullYear(),dt.getMonth());});
    document.getElementById('nextMonth').addEventListener('click',()=>{const dt=new Date(viewYear,viewMonth+1,1); setView(dt.getFullYear(),dt.getMonth());});
    document.getElementById('todayBtn').addEventListener('click',()=>{const t=new Date(); setView(t.getFullYear(),t.getMonth());});
    document.getElementById('clearBtn').addEventListener('click',async()=>{if(confirm('Clear all streaks?')){for(const k of Object.keys(cache)){if(cache[k]){await deleteDoc(streakRef(k)); cache[k]=false;}} render();}});

    document.getElementById('logoutBtn').addEventListener('click', async ()=>{
      await signOut(auth);
    });

    document.getElementById('loginForm').addEventListener('submit', async (e)=>{
      e.preventDefault();
      const email=document.getElementById('email').value;
      const password=document.getElementById('password').value;
      try{
        await signInWithEmailAndPassword(auth, email, password);
      } catch(err){
        alert("Login failed: "+err.message);
        document.getElementById('password').focus();
      }
    });

    onAuthStateChanged(auth, async (user)=>{
const loginFormDisplay = document.getElementById('loginForm').style.display;
      if(user){
        userId=user.uid;
        document.getElementById('loginForm').style.display='none';
        document.getElementById('logoutBtn').style.display='inline-block';
        const t=new Date();
        setView(t.getFullYear(), t.getMonth());
await loadStreakList();
await loadStreak(currentStreakName);
      } else {
        userId=null;
        document.getElementById('loginForm').style.display=loginFormDisplay;
        document.getElementById('logoutBtn').style.display='none';
        document.getElementById('email').focus();
      }
    });

    let currentStreakName = "default"; // or "Running", "Meditation", etc.

    document.getElementById('streakSelect').addEventListener('change', async e => {
      currentStreakName = e.target.value;
      cache = {};
      const t = new Date();
      setView(t.getFullYear(), t.getMonth());

  // update checkbox
  await syncPublicCheckbox(currentStreakName);
    });

async function loadStreakList() {
  const select = document.getElementById("streakSelect");
  select.innerHTML = ""; // clear existing

  if(null === userId) return;
  const streaksCol = collection(db, "users", userId, "streaks");
  const snaps = await getDocs(streaksCol);

  if (snaps.empty) {
    // create a default streak if none exist
    await setDoc(doc(db, "users", userId, "streaks", "default"), {
      createdAt: Date.now()
    });
    const opt = document.createElement("option");
    opt.value = "default";
    opt.textContent = "default";
    select.appendChild(opt);
    currentStreakName = "default";
    return;
  }

  snaps.forEach(docSnap => {

    const name = docSnap.id;
    const opt = document.createElement("option");
    opt.value = name;
    opt.textContent = name;
    select.appendChild(opt);
  });

  // pick first streak as active
  currentStreakName = select.options[0].value;
  select.value = currentStreakName;
}

document.getElementById("newStreakBtn").addEventListener("click", async () => {
  const name = prompt("Enter a name for your new streak:");
  if (!name) return;

  const safeName = name.trim().replace(/[.#$/[\]]/g, "_");
  if (!safeName) return alert("Invalid streak name");

  const streakDoc = doc(db, "users", userId, "streaks", safeName);
  await setDoc(streakDoc, { createdAt: Date.now() });

  // refresh list
  await loadStreakList();

  // select new streak
  document.getElementById("streakSelect").value = safeName;
  currentStreakName = safeName;
  cache = {};
  const t = new Date();
  setView(t.getFullYear(), t.getMonth());
});

await loadStreakList();
const t = new Date();
setView(t.getFullYear(), t.getMonth());

async function togglePublic(streakName, value) {
  const streakDoc = doc(db, "users", userId, "streaks", streakName);
  await setDoc(streakDoc, { public: value }, { merge: true });


}

const publicToggle = document.getElementById("publicToggle");
publicToggle.addEventListener("click", async () => { 
  togglePublic(currentStreakName, publicToggle.checked); 
});

publicToggle.addEventListener("change", async (e) => { 
 // Toggle share link visibility
  document.getElementById("shareLinkBtn").style.display = e.target.checked ? "inline-block" : "none";
});

document.getElementById("shareLinkBtn").addEventListener("click", async () => {
  const link = `${window.location.origin}?user=${userId}&streak=${encodeURIComponent(currentStreakName)}`;
  await navigator.clipboard.writeText(link);
  alert("Share link copied to clipboard!");
});



async function syncPublicCheckbox(streakName) {
  const checkbox = document.getElementById("publicToggle");
  if (!streakName || !userId) return;

  const streakDocRef = doc(db, "users", userId, "streaks", streakName);
  const streakSnap = await getDoc(streakDocRef);

  if (streakSnap.exists()) {
    const data = streakSnap.data();
    checkbox.checked = !!data.public;  // set checkbox state
  } else {
    checkbox.checked = false; // default to private if no doc
  }
}

async function loadStreak(streakName) {
  if (!userId) return;

  currentStreakName = streakName;
  cache = {};

  // 🔹 Sync public toggle
  const checkbox = document.getElementById("publicToggle");
  const streakDocRef = doc(db, "users", userId, "streaks", streakName);
  const streakSnap = await getDoc(streakDocRef);
  if (streakSnap.exists()) {
    checkbox.checked = !!streakSnap.data().public;
  } else {
    checkbox.checked = false;
  }

const shareBtn = document.getElementById("shareLinkBtn");
if (checkbox.checked) {
  shareBtn.style.display = "inline-block";
} else {
  shareBtn.style.display = "none";
}

  // 🔹 Refresh the calendar
  const today = new Date();
  setView(today.getFullYear(), today.getMonth());
}

document.getElementById('streakSelect').addEventListener('change', e => {
  loadStreak(e.target.value);
});


  </script>
</body>
</html>


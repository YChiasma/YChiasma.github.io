<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Perfect Pitch Trainer</title>
  <style>
    :root{--bg:#0f1724;--card:#071029;--accent:#60a5fa;--muted:#94a3b8;--success:#10b981;--danger:#ef4444}
    html,body{height:100%}
    body{font-family:Inter,ui-sans-serif,system-ui,Segoe UI,Roboto,Helvetica,Arial;display:flex;align-items:center;justify-content:center;margin:0;background:linear-gradient(180deg,#071021 0%, #0b1220 100%);color:#e6eef8}
    .app{width:980px;max-width:95%;padding:26px;border-radius:12px;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));box-shadow:0 8px 30px rgba(2,6,23,0.8)}
    header{display:flex;align-items:center;gap:16px}
    h1{margin:0;font-size:20px}
    .controls{display:flex;gap:12px;margin-top:18px;align-items:center}
    button,select,input[type=text]{background:rgba(255,255,255,0.03);border:1px solid rgba(255,255,255,0.04);color:var(--muted);padding:10px 12px;border-radius:8px}
    button{cursor:pointer;color:#e6eef8}
    .big-play{font-size:18px;padding:12px 18px}
    .main{display:grid;grid-template-columns:1fr 320px;gap:20px;margin-top:20px}
    .card{background:var(--card);padding:16px;border-radius:10px}
    .big-note{font-size:42px;letter-spacing:1px;color:var(--accent);font-weight:700}
    .info-row{display:flex;justify-content:space-between;gap:12px;margin-top:12px}
    label{display:block;font-size:12px;color:var(--muted);margin-bottom:6px}
    .stats{display:flex;flex-direction:column;gap:12px}
    .stat-row{display:flex;justify-content:space-between;align-items:center}
    .progress{height:10px;background:rgba(255,255,255,0.04);border-radius:8px;overflow:hidden}
    .progress > i{display:block;height:100%;background:linear-gradient(90deg,var(--accent),#7dd3fc)}
    .last10{display:flex;gap:6px;flex-wrap:wrap}
    .dot{width:18px;height:18px;border-radius:50%;display:inline-flex;align-items:center;justify-content:center;font-size:11px}
    .dot.ok{background:var(--success);color:#022c22}
    .dot.bad{background:var(--danger);color:#2b0505}
    .small-muted{font-size:13px;color:var(--muted)}
    footer{margin-top:18px;font-size:13px;color:var(--muted)}
    .kbd{background:rgba(255,255,255,0.03);padding:4px 8px;border-radius:6px;border:1px solid rgba(255,255,255,0.02);font-size:13px}
    @media (max-width:880px){.main{grid-template-columns:1fr;}}
  </style>
</head>
<body>
  <div class="app" role="application">
    <header>
      <svg width="36" height="36" viewBox="0 0 24 24" fill="none" aria-hidden>
        <rect x="3" y="3" width="18" height="18" rx="4" fill="#0ea5e9" opacity="0.15"></rect>
        <path d="M8 7v10" stroke="#60a5fa" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path>
        <path d="M11.5 6v8.5a2 2 0 1 0 2 0V6" stroke="#60a5fa" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"></path>
      </svg>
      <div>
        <h1>Perfect Pitch Trainer</h1>
        <div class="small-muted">Plays a tone — enter the note (e.g. C4, F#5). Tracks score and last 10.</div>
      </div>
    </header>

    <div class="controls">
      <button id="playBtn" class="big-play">▶ Play Tone (Space)</button>
      <label style="display:flex;flex-direction:column">
        <span class="small-muted">Range</span>
        <select id="rangeSel">
          <option value="48,72">C3 — C5 (easier)</option>
          <option value="48,84" selected>C3 — C6</option>
          <option value="40,88">E2 — E6 (wide)</option>
        </select>
      </label>
      <label style="display:flex;flex-direction:column">
        <span class="small-muted">Timbre</span>
        <select id="waveSel">
          <option value="sine">Sine</option>
          <option value="triangle">Triangle</option>
          <option value="sawtooth">Sawtooth</option>
          <option value="square">Square</option>
        </select>
      </label>
      <div style="margin-left:auto;display:flex;gap:8px;align-items:center">
        <div class="small-muted">Volume</div>
        <input id="vol" type="range" min="0" max="1" step="0.01" value="0.4" style="width:120px">
      </div>
    </div>

    <div class="main">
      <div>
        <div class="card">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <div class="small-muted">Current Tone</div>
              <div class="big-note" id="currentNote">—</div>
            </div>
            <div style="text-align:right">
              <div class="small-muted">Attempts</div>
              <div id="attemptCount" style="font-size:20px;font-weight:700">0</div>
            </div>
          </div>

          <div style="margin-top:14px;display:flex;gap:10px;align-items:center">
            <label style="flex:1">
              <div class="small-muted">Enter note</div>
              <input id="guessInput" type="text" placeholder="e.g. C4, F#5, Db3" style="width:100%" autocomplete="off">
            </label>
            <div style="display:flex;flex-direction:column;gap:8px">
              <button id="submitBtn">Submit</button>
              <button id="revealBtn">Reveal</button>
            </div>
          </div>

          <div class="info-row">
            <div>
              <div class="small-muted">Previous guess</div>
              <div id="prevGuess">—</div>
            </div>
            <div>
              <div class="small-muted">Previous correct</div>
              <div id="prevCorrect">—</div>
            </div>
          </div>

          <div style="margin-top:12px" class="stats">
            <div class="stat-row">
              <div>
                <div class="small-muted">Overall Score</div>
                <div id="scoreText" style="font-weight:700">0 / 0</div>
              </div>
              <div style="width:50%">
                <div class="progress" aria-hidden><i id="overallBar" style="width:0%"></i></div>
                <div class="small-muted" style="margin-top:6px" id="overallPercent">0%</div>
              </div>
            </div>

            <div class="stat-row">
              <div>
                <div class="small-muted">Last 10</div>
                <div id="last10Text" style="font-weight:700">—</div>
              </div>
              <div style="width:50%">
                <div class="progress" aria-hidden><i id="last10Bar" style="width:0%"></i></div>
                <div class="small-muted" style="margin-top:6px" id="last10Percent">—</div>
              </div>
            </div>

            <div style="margin-top:6px">
              <div class="small-muted">Last 10 answers</div>
              <div class="last10" id="last10Dots"></div>
            </div>
          </div>
        </div>

        <div style="margin-top:12px" class="card small-muted">
          Keyboard: <span class="kbd">Space</span> play / <span class="kbd">Enter</span> submit • Accepts sharps (#) and flats (b) • Case-insensitive
        </div>
      </div>

      <aside>
        <div class="card">
          <h3 style="margin:0 0 8px 0">Controls & History</h3>
          <div class="small-muted">Recent rounds (most recent first)</div>
          <div id="historyList" style="margin-top:12px;display:flex;flex-direction:column;gap:8px;max-height:360px;overflow:auto"></div>
          <footer>
            <div class="small-muted">Data stored locally in your browser. Reload retains progress.</div>
          </footer>
        </div>
      </aside>
    </div>
  </div>

  <script>
  // Perfect Pitch Trainer - Single-file HTML/JS
  (function(){
    // Utilities: note <-> midi <-> frequency
    const SEMITONES = { 'C':0,'C#':1,'DB':1,'D':2,'D#':3,'EB':3,'E':4,'F':5,'F#':6,'GB':6,'G':7,'G#':8,'AB':8,'A':9,'A#':10,'BB':10,'B':11 };
    function parseNoteName(name){
      if(!name || typeof name !== 'string') return null;
      name = name.trim().toUpperCase().replace(/\s+/g,'');
      const m = name.match(/^([A-G])([#B]?)(-?\d+)$/);
      if(!m) return null;
      let [_, letter, acc, oct] = m;
      const key = letter + (acc || '');
      const sem = SEMITONES[key];
      if(sem === undefined) return null;
      const octave = parseInt(oct,10);
      const midi = (octave + 1) * 12 + sem; // C4 -> 60
      return { name: letter + (acc || '') + octave, midi };
    }
    function midiToFreq(m){ return 440 * Math.pow(2,(m - 69)/12); }
    function midiToName(m){
      const sem = m % 12; const oct = Math.floor(m/12)-1;
      const names = ['C','C#','D','D#','E','F','F#','G','G#','A','A#','B'];
      return names[(sem+12)%12] + oct;
    }

    // Audio
    const AudioCtx = window.AudioContext || window.webkitAudioContext;
    const ctx = new AudioCtx();
    let masterGain = ctx.createGain(); masterGain.gain.value = 0.4; masterGain.connect(ctx.destination);

    function playTone(freq, duration=0.8, type='sine'){
      // resume context if suspended
      if(ctx.state === 'suspended') ctx.resume();
      const o = ctx.createOscillator();
      const g = ctx.createGain();
      o.type = type; o.frequency.value = freq;
      g.gain.value = 0.0001;
      o.connect(g); g.connect(masterGain);
      const now = ctx.currentTime;
      g.gain.linearRampToValueAtTime(masterGain.gain.value, now + 0.02);
      o.start(now);
      g.gain.exponentialRampToValueAtTime(0.0001, now + duration);
      o.stop(now + duration + 0.02);
    }

    // UI refs
    const playBtn = document.getElementById('playBtn');
    const guessInput = document.getElementById('guessInput');
    const submitBtn = document.getElementById('submitBtn');
    const revealBtn = document.getElementById('revealBtn');
    const currentNoteEl = document.getElementById('currentNote');
    const prevGuessEl = document.getElementById('prevGuess');
    const prevCorrectEl = document.getElementById('prevCorrect');
    const attemptCountEl = document.getElementById('attemptCount');
    const scoreText = document.getElementById('scoreText');
    const overallBar = document.getElementById('overallBar');
    const overallPercent = document.getElementById('overallPercent');
    const last10Bar = document.getElementById('last10Bar');
    const last10Percent = document.getElementById('last10Percent');
    const last10Dots = document.getElementById('last10Dots');
    const last10Text = document.getElementById('last10Text');
    const historyList = document.getElementById('historyList');
    const rangeSel = document.getElementById('rangeSel');
    const waveSel = document.getElementById('waveSel');
    const vol = document.getElementById('vol');

    // State
    let currentMidi = null;
    let attempts = 0, correct = 0;
    let last10 = []; // booleans, most recent first
    let rounds = []; // {midi, correctGuess (string|null), isCorrect, timestamp}

    const STORAGE_KEY = 'ppt_trainer_v1';
    function saveState(){
      const payload = {attempts,correct,last10,rounds};
      localStorage.setItem(STORAGE_KEY, JSON.stringify(payload));
    }
    function loadState(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY); if(!raw) return;
        const p = JSON.parse(raw);
        attempts = p.attempts||0; correct = p.correct||0; last10 = p.last10||[]; rounds = p.rounds||[];
      }catch(e){console.warn('load failed',e)}
    }

    function pickRandomMidi(){
      const [lo,hi] = rangeSel.value.split(',').map(Number);
      return Math.floor(Math.random()*(hi - lo + 1)) + lo;
    }

    function newRound(){
      currentMidi = pickRandomMidi();
      currentNoteEl.textContent = '—';
      // Update UI but keep currentMidi internally
    }

    function showCurrentAsHint(){
      currentNoteEl.textContent = midiToName(currentMidi);
    }

    function reveal(){
      // play and show correct
      if(currentMidi == null) return;
      const freq = midiToFreq(currentMidi);
      playTone(freq, 0.9, waveSel.value);
      showCurrentAsHint();
    }

    function submitGuess(){
      const raw = guessInput.value.trim();
      if(!raw){guessInput.focus(); return}
      const parsed = parseNoteName(raw);
      const userName = parsed ? parsed.name : raw.toUpperCase();
      const userMidi = parsed ? parsed.midi : null;
      const isCorrect = userMidi !== null && userMidi === currentMidi;
      attempts += 1; if(isCorrect) correct += 1;
      last10.unshift(!!isCorrect); if(last10.length>10) last10.pop();
      const entry = { midi: currentMidi, correctGuess: userName, isCorrect, ts: Date.now() };
      rounds.unshift(entry); if(rounds.length>200) rounds.pop();
      prevGuessEl.textContent = userName;
      prevCorrectEl.textContent = midiToName(currentMidi);
      attemptCountEl.textContent = attempts;
      updateStats();
      saveState();

      // Play feedback tone + reveal correct tone
      if(isCorrect){
        // play a short pleasant interval
        playTone(midiToFreq(currentMidi), 0.6, waveSel.value);
      } else {
        // play a lower 'wrong' buzz then correct
        playTone(150, 0.18, 'sawtooth');
        setTimeout(()=> playTone(midiToFreq(currentMidi), 0.9, waveSel.value), 220);
      }

      // prepare next round after a short delay
      setTimeout(()=>{
        guessInput.value = '';
        newRound();
        guessInput.focus();
      }, 700);
    }

    function updateStats(){
      scoreText.textContent = `${correct} / ${attempts}`;
      const pct = attempts? Math.round(correct/attempts*100):0;
      overallBar.style.width = pct + '%';
      overallPercent.textContent = pct + '%';

      const last10Count = last10.reduce((a,b)=>a+(b?1:0),0);
      last10Bar.style.width = (last10.length? Math.round(last10Count/last10.length*100):0) + '%';
      last10Percent.textContent = last10.length? `${last10Count} / ${last10.length}` : '—';
      last10Text.textContent = last10.length? `${last10Count} / ${last10.length}` : '—';

      // dots
      last10Dots.innerHTML = '';
      last10.forEach((ok,i)=>{
        const d = document.createElement('div'); d.className = 'dot ' + (ok? 'ok' : 'bad'); d.title = ok? 'Correct' : 'Incorrect';
        d.textContent = i+1; last10Dots.appendChild(d);
      });

      // history list
      historyList.innerHTML = '';
      rounds.slice(0,30).forEach(r=>{
        const el = document.createElement('div'); el.style.display='flex'; el.style.justifyContent='space-between'; el.style.alignItems='center';
        const left = document.createElement('div'); left.innerHTML = `<strong>${midiToName(r.midi)}</strong> <span class="small-muted">• ${new Date(r.ts).toLocaleString()}</span>`;
        const right = document.createElement('div'); right.innerHTML = `${r.correctGuess || '—'} <span style="margin-left:8px" class="small-muted">${r.isCorrect? '✓' : '✕'}</span>`;
        el.appendChild(left); el.appendChild(right); historyList.appendChild(el);
      });
    }

    // Event hookups
    playBtn.addEventListener('click', ()=>{
      if(!currentMidi) currentMidi = pickRandomMidi();
      playTone(midiToFreq(currentMidi), 0.9, waveSel.value);
      currentNoteEl.textContent = '—';
    });
    submitBtn.addEventListener('click', submitGuess);
    revealBtn.addEventListener('click', ()=>{ reveal(); });

    // keyboard
    document.addEventListener('keydown', (e)=>{
      if(e.code === 'Space'){
        e.preventDefault(); playBtn.click();
      } else if(e.key === 'Enter'){
        const active = document.activeElement;
        if(active === guessInput) submitBtn.click();
      }
    });

    // volume control
    vol.addEventListener('input', ()=>{ masterGain.gain.value = Number(vol.value); });

    // Init
    loadState(); updateStats(); newRound();
    // prefocus
    setTimeout(()=>{ guessInput.focus(); }, 300);

    // expose for debugging in console
    window.ppt = { playTone, parseNoteName, midiToName };
  })();
  </script>
</body>
</html>
